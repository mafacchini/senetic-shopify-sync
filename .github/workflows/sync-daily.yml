name: 'ğŸ›ï¸ Sincronizzazione Senetic â†’ Shopify'

on:
  schedule:
    # Ogni giorno alle 6:00 UTC (8:00 ora italiana CEST)
    - cron: '0 6 * * *'
  workflow_dispatch: # Permette esecuzione manuale dal pulsante

env:
  API_URL: 'https://app-senetic-shopify.vercel.app'

jobs:
  sync-products:
    name: 'ğŸ“¦ Importa Prodotti da Senetic'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: 'ğŸš€ Inizio Sincronizzazione'
        run: |
          echo "ğŸ•• Avvio sincronizzazione automatica alle $(date)"
          echo "ğŸŒ URL API: ${{ env.API_URL }}"
          echo "ğŸ“… Esecuzione programmata: ogni giorno alle 6:00 UTC"
          
      - name: 'ğŸ” Verifica Stato API'
        run: |
          echo "ğŸ“¡ Controllo che l'API sia online..."
          response=$(curl -s -w "%{http_code}" -o /dev/null ${{ env.API_URL }})
          
          if [ $response -eq 200 ]; then
            echo "âœ… API online e raggiungibile"
          else
            echo "âŒ API non raggiungibile (HTTP $response)"
            exit 1
          fi
          
      - name: 'ğŸ“¡ Esegui Sincronizzazione'
        run: |
          echo "ğŸ”„ Avvio processo di sincronizzazione..."
          
          # Esegui la chiamata API con timeout di 20 minuti
          response=$(curl -s -w "%{http_code}" -o response.json --max-time 1200 \
            -X GET \
            -H "X-Cron-Token: ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            "${{ env.API_URL }}/import-shopify-cron")
          
          # Verifica se la risposta Ã¨ successo
          if [ $response -eq 200 ]; then
            echo "âœ… Sincronizzazione completata con successo!"
          else
            echo "âŒ Errore durante la sincronizzazione (HTTP $response)"
            echo "ğŸ“„ Dettagli errore:"
            cat response.json
            exit 1
          fi
          
      - name: 'ğŸ“Š Salva Logs di Sincronizzazione'
        if: always()
        run: |
          echo "ğŸ’¾ Salvataggio logs per debug..."
          
          if [ -f response.json ]; then
            echo "ğŸ“‹ Risposta API:"
            cat response.json | jq '.' 2>/dev/null || cat response.json
          else
            echo "âš ï¸ Nessuna risposta salvata"
          fi
          
      - name: 'ğŸ¯ Riepilogo Finale'
        if: always()
        run: |
          echo "ğŸ“‹ === RIEPILOGO SINCRONIZZAZIONE ==="
          echo "ğŸ• Completato alle: $(date)"
          echo "ğŸ†” Workflow ID: ${{ github.run_id }}"
          echo "ğŸ“ Eseguito da: ${{ github.event_name }}"
          
          if [ -f response.json ]; then
            if command -v jq &> /dev/null; then
              processed=$(cat response.json | jq -r '.stats.processed // "N/A"')
              success=$(cat response.json | jq -r '.stats.success // "N/A"')
              errors=$(cat response.json | jq -r '.stats.errors // "N/A"')
              
              echo "ğŸ“¦ Prodotti processati: $processed"
              echo "âœ… Successi: $success"
              echo "âŒ Errori: $errors"
            fi
          fi
          
          echo "ğŸ”— Visualizza dettagli: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"