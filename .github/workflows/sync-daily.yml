name: 'ğŸ›ï¸ Sincronizzazione Senetic â†’ Shopify'

on:
  # ğŸ”¥ TRIGGER SU WEBHOOK da Shopify
  repository_dispatch:
    types: [shopify_update]
  
  # ğŸ“± TRIGGER MANUALE (mantieni per debug)
  workflow_dispatch:
  
  # â° TRIGGER PROGRAMMATO (opzionale - backup)
  schedule:
    # Backup ogni 6 ore nel caso il webhook fallisca
    - cron: '0 */6 * * *'

env:
  API_URL: 'https://app-senetic-shopify.vercel.app'

jobs:
  sync-products:
    name: 'ğŸ”„ Sync Triggered by Shopify Update'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: 'ğŸš€ Detect Trigger Type'
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "ğŸ”” Attivato da webhook Shopify!"
            echo "ğŸ“ Tipo evento: ${{ github.event.action }}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ğŸ‘¤ Attivato manualmente"
          else
            echo "â° Attivato da schedule"
          fi
    
      - name: 'ğŸš€ Inizio Sincronizzazione'
        run: |
          echo "ğŸ•• Avvio sincronizzazione automatica alle $(date)"
          echo "ğŸŒ URL API: ${{ env.API_URL }}"
          echo "ğŸ“… Esecuzione programmata: ogni giorno alle 6:00 UTC"
          
      - name: 'ğŸ” Verifica Stato API'
        run: |
          echo "ğŸ“¡ Controllo che l'API sia online..."
          response=$(curl -s -w "%{http_code}" -o /dev/null ${{ env.API_URL }})
          
          if [ $response -eq 200 ]; then
            echo "âœ… API online e raggiungibile"
          else
            echo "âŒ API non raggiungibile (HTTP $response)"
            exit 1
          fi
          
      - name: 'ğŸ“¡ Esegui Sincronizzazione'
        run: |
          echo "ğŸ”„ Avvio processo di sincronizzazione..."
          
          # Esegui la chiamata API con timeout di 20 minuti
          response=$(curl -s -w "%{http_code}" -o response.json --max-time 1200 \
            -H "X-Cron-Token: ${{ secrets.CRON_SECRET }}" \
            ${{ env.API_URL }}/import-shopify-cron)
          
          echo "ğŸ“Š Codice risposta HTTP: $response"
          
          # Verifica se la risposta Ã¨ successo
          if [ $response -eq 200 ]; then
            echo "âœ… Sincronizzazione completata con successo!"
          else
            echo "âŒ Errore durante la sincronizzazione (HTTP $response)"
            echo "ğŸ“„ Dettagli errore:"
            cat response.json
            exit 1
          fi
          
      - name: 'ğŸ“Š Salva Logs di Sincronizzazione'
        if: always()
        run: |
          echo "ğŸ’¾ Salvataggio logs per debug..."
          
          # Crea un file di log con timestamp
          log_file="sync-log-$(date +%Y%m%d-%H%M%S).json"
          
          # Aggiungi metadata al log
          echo "{" > $log_file
          echo "  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"," >> $log_file
          echo "  \"workflow_run\": \"${{ github.run_id }}\"," >> $log_file
          echo "  \"trigger\": \"${{ github.event_name }}\"," >> $log_file
          echo "  \"api_response\": " >> $log_file
          cat response.json >> $log_file
          echo "}" >> $log_file
          
          echo "ğŸ“ Log salvato in: $log_file"
          
      - name: 'ğŸ¯ Riepilogo Finale'
        if: always()
        run: |
          echo "ğŸ“‹ === RIEPILOGO SINCRONIZZAZIONE ==="
          echo "ğŸ• Completato alle: $(date)"
          echo "ğŸ†” Workflow ID: ${{ github.run_id }}"
          echo "ğŸ“ Eseguito da: ${{ github.event_name }}"
          
          if [ -f response.json ]; then
            if command -v jq &> /dev/null; then
              processed=$(cat response.json | jq -r '.stats.processed // "N/A"')
              success=$(cat response.json | jq -r '.stats.success // "N/A"')
              errors=$(cat response.json | jq -r '.stats.errors // "N/A"')
              
              echo "ğŸ“¦ Prodotti processati: $processed"
              echo "âœ… Successi: $success"
              echo "âŒ Errori: $errors"
            fi
          fi
          
          echo "ğŸ”— Visualizza dettagli: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"