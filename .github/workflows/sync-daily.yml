name: 'ğŸ›ï¸ Sincronizzazione Senetic â†’ Shopify'

on:
  schedule:
    # Ogni giorno alle 6:00 UTC (8:00 ora italiana CEST)
    - cron: '0 6 * * *'
  workflow_dispatch: # Permette esecuzione manuale dal pulsante

env:
  API_URL: 'https://app-senetic-shopify-mzu6ru5o5-massimos-projects-165d2cc0.vercel.app'

jobs:
  sync-products:
    name: 'ğŸ“¦ Importa Prodotti da Senetic'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: 'ğŸš€ Inizio Sincronizzazione'
        run: |
          echo "ğŸ•• Avvio sincronizzazione automatica alle $(date)"
          echo "ğŸŒ URL API: ${{ env.API_URL }}"
          echo "ğŸ“… Esecuzione programmata: ogni giorno alle 6:00 UTC"
          
      - name: 'ğŸ” Verifica Stato API'
        run: |
          echo "ğŸ“¡ Controllo che l'API sia online..."
          response=$(curl -s -w "%{http_code}" -o /dev/null ${{ env.API_URL }})
          
          if [ $response -eq 200 ]; then
            echo "âœ… API online e raggiungibile"
          else
            echo "âŒ API non raggiungibile (HTTP $response)"
            exit 1
          fi
          
      - name: 'ğŸ“¡ Esegui Sincronizzazione'
        run: |
          echo "ğŸ”„ Avvio processo di sincronizzazione..."
          
          # Esegui la chiamata API con timeout di 20 minuti
          response=$(curl -s -w "%{http_code}" -o response.json --max-time 1200 \
            -H "X-Cron-Token: ${{ secrets.CRON_SECRET }}" \
            ${{ env.API_URL }}/import-shopify-cron)
          
          echo "ğŸ“Š Codice risposta HTTP: $response"
          
          # ğŸ” DEBUG: Mostra il contenuto raw del file
          echo "ğŸ“„ Contenuto raw di response.json:"
          cat response.json
          echo ""
          echo "ğŸ“ Dimensione file: $(wc -c < response.json) bytes"
          
          # Verifica se la risposta Ã¨ successo
          if [ $response -eq 200 ]; then
            echo "âœ… Sincronizzazione completata con successo!"
            
            # ğŸ” DEBUG: Controlla se Ã¨ JSON valido prima di usare jq
            if command -v jq &> /dev/null; then
              if jq empty response.json 2>/dev/null; then
                echo "âœ… JSON valido, elaboro statistiche..."
                echo "ğŸ“ˆ Statistiche sincronizzazione:"
                cat response.json | jq '.stats // empty'
                
                echo "ğŸ“‹ Primi 3 prodotti processati:"
                cat response.json | jq '.risultati[0:3] // empty'
              else
                echo "âŒ JSON non valido in response.json"
                echo "ğŸ“„ Contenuto file:"
                head -200 response.json
              fi
            else
              echo "ğŸ“„ jq non disponibile, mostro contenuto raw:"
              head -500 response.json
            fi
            
          else
            echo "âŒ Errore durante la sincronizzazione (HTTP $response)"
            echo "ğŸ“„ Dettagli errore:"
            cat response.json
            exit 1
          fi
          
      - name: 'ğŸ“Š Salva Logs di Sincronizzazione'
        if: always()
        run: |
          echo "ğŸ’¾ Salvataggio logs per debug..."
          
          # Crea un file di log con timestamp
          log_file="sync-log-$(date +%Y%m%d-%H%M%S).json"
          
          # Aggiungi metadata al log
          echo "{" > $log_file
          echo "  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"," >> $log_file
          echo "  \"workflow_run\": \"${{ github.run_id }}\"," >> $log_file
          echo "  \"trigger\": \"${{ github.event_name }}\"," >> $log_file
          echo "  \"api_response\": " >> $log_file
          cat response.json >> $log_file
          echo "}" >> $log_file
          
          echo "ğŸ“ Log salvato in: $log_file"
          
      - name: 'ğŸ¯ Riepilogo Finale'
        if: always()
        run: |
          echo "ğŸ“‹ === RIEPILOGO SINCRONIZZAZIONE ==="
          echo "ğŸ• Completato alle: $(date)"
          echo "ğŸ†” Workflow ID: ${{ github.run_id }}"
          echo "ğŸ“ Eseguito da: ${{ github.event_name }}"
          
          if [ -f response.json ]; then
            if command -v jq &> /dev/null; then
              processed=$(cat response.json | jq -r '.stats.processed // "N/A"')
              success=$(cat response.json | jq -r '.stats.success // "N/A"')
              errors=$(cat response.json | jq -r '.stats.errors // "N/A"')
              
              echo "ğŸ“¦ Prodotti processati: $processed"
              echo "âœ… Successi: $success"
              echo "âŒ Errori: $errors"
            fi
          fi
          
          echo "ğŸ”— Visualizza dettagli: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"